<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horario de Guardias</title>
    <link rel="stylesheet" href="css/estilo.css" />
    <link rel="icon" href="https://iesescultorjoseluissanchez.com/wp-content/uploads/2024/08/01-LOGO_TRANSPARENTE-MORADOx120.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.0/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <h1>Horario de Guardias</h1>
        <main>
            <div v-for="dia in dias" :id="dia.toLowerCase()" :key="dia" 
                 :class="{ 'expanded': dia === diaSeleccionado }"
                 @click="seleccionarDia(dia)">
                <strong>{{ dia }}</strong>
                <div v-for="(hora, index) in horas" :key="hora" 
                     :id="'hora' + (index + 1)" 
                     class="guardia"
                     :class="{ 'sin-firmar': tieneGuardiasSinFirmar(dia, hora) }">
                    <template v-if="obtenerGuardias(dia, hora).length">
                        <div v-for="guardia in obtenerGuardias(dia, hora)" :key="guardia.id">
                            {{ obtenerProfesorNombre(guardia.profesor_id) }} ({{ guardia.aula }})
                        </div>
                    </template>
                    <template v-else>
                        {{ hora }}
                    </template>
                </div>
            </div>
        </main>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    dias: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"],
                    horas: [
                        "08:30 - 09:25", "09:25 - 10:20", "10:20 - 11:15",
                        "11:15 - 11:45", "11:45 - 12:40", "12:40 - 13:35", "13:35 - 14:30"
                    ],
                    profesores: [],
                    guardias: [],
                    diaSeleccionado: null
                };
            },
            mounted() {
                this.cargarDatos();
                this.expandirDiaActual();
            },
            methods: {
                async cargarDatos() {
                    try {
                        let responseProfesores = await fetch("http://localhost:3000/profesores");
                        this.profesores = await responseProfesores.json();
                        
                        let responseGuardias = await fetch("http://localhost:3000/guardias");
                        this.guardias = await responseGuardias.json();
                    } catch (error) {
                        console.error("Error cargando datos:", error);
                    }
                },
                obtenerProfesorNombre(profesor_id) {
                    const profesor = this.profesores.find(p => p.id === profesor_id);
                    return profesor ? profesor.nombre : "Desconocido";
                },
                obtenerGuardias(dia, hora) {
                    return this.guardias.filter(g => 
                        g.dia.trim().toLowerCase() === dia.trim().toLowerCase() && 
                        g.hora.trim() === hora.trim()
                    );
                },
                tieneGuardiasSinFirmar(dia, hora) {
                    return this.obtenerGuardias(dia, hora).some(g => !g.registro_firmado);
                },
                seleccionarDia(dia) {
                    this.diaSeleccionado = this.diaSeleccionado === dia ? null : dia;
                },
                expandirDiaActual() {
                    const diasMap = {
                        1: "Lunes",
                        2: "Martes",
                        3: "Miércoles",
                        4: "Jueves",
                        5: "Viernes"
                    };
                    const hoy = new Date().getDay(); // Devuelve un número del 0 (Domingo) al 6 (Sábado)
                    if (diasMap[hoy]) {
                        this.diaSeleccionado = diasMap[hoy]; // Selecciona el día correcto
                    }
                }
            }
        });

        app.mount("#app");
    </script>

</body>
</html>
